<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broken Arrow Maggot Index</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .maggot-meter-bg {
            background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
            height: 20px;
            border-radius: 10px;
            position: relative;
            margin-top: 10px;
        }
        .maggot-indicator {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 30px;
            background-color: white;
            border: 2px solid black;
            transform: translateX(-50%);
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .match-row {
            transition: all 0.2s;
        }
        .match-row:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .lang-btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background-color: #06b6d4;
            border-color: #06b6d4;
            color: white;
        }
        .teammate-badge {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            padding: 2px 6px;
            margin-bottom: 2px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        .teammate-badge.is-me {
            background: rgba(6, 182, 212, 0.3);
            border: 1px solid rgba(6, 182, 212, 0.8);
            color: #fff;
            font-weight: bold;
        }
        .rank-pill {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 4px;
        }
        .rank-pill-kill { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.4); }
        .rank-pill-cap { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.4); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-10 px-4 pb-10">

    <div id="langModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-8 rounded-xl max-w-sm w-full text-center shadow-2xl">
            <h2 class="text-xl font-bold mb-6 text-white">Select Language / é€‰æ‹©è¯­è¨€</h2>
            <div class="flex flex-col gap-3">
                <button onclick="selectLanguage('en')" class="p-3 rounded bg-slate-700 hover:bg-cyan-600 transition text-white border border-slate-600">English</button>
                <button onclick="selectLanguage('zh')" class="p-3 rounded bg-slate-700 hover:bg-cyan-600 transition text-white border border-slate-600">ä¸­æ–‡</button>
                <button onclick="selectLanguage('ru')" class="p-3 rounded bg-slate-700 hover:bg-cyan-600 transition text-white border border-slate-600">Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
            </div>
        </div>
    </div>

    <div id="playerSelectModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-8 rounded-xl max-w-md w-full shadow-2xl">
            <h2 class="text-xl font-bold mb-2 text-white text-center" id="lbl_select_player_title">Identity Confirmation</h2>
            <p class="text-sm text-slate-400 mb-6 text-center" id="lbl_select_player_desc">Multiple players have identical match history. Please select yourself:</p>
            <div id="playerSelectList" class="flex flex-col gap-2 max-h-[300px] overflow-y-auto"></div>
            <button onclick="closePlayerModal()" class="mt-4 w-full py-2 text-xs text-slate-500 hover:text-white transition">Cancel</button>
        </div>
    </div>

    <div class="w-full max-w-5xl flex justify-between items-center mb-4 px-2">
        <div class="text-xs text-slate-500">v1.6 By Zola</div>
        <div class="flex gap-2">
            <button onclick="setLanguage('en')" id="btn_en" class="lang-btn">EN</button>
            <button onclick="setLanguage('zh')" id="btn_zh" class="lang-btn">ä¸­æ–‡</button>
            <button onclick="setLanguage('ru')" id="btn_ru" class="lang-btn">RU</button>
        </div>
    </div>

    <div class="glass-panel w-full max-w-5xl rounded-2xl p-8">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-2 flex items-baseline justify-center">
                <span id="lbl_title">æ–­ç®­è›†æŒ‡æ•°</span>
                <span class="text-sm font-normal text-slate-500 ml-3 italic">By Zola</span>
            </h1>
            <p class="text-slate-400 text-sm" id="lbl_subtitle">Broken Arrow Maggot Index</p>
            
            <a href="https://batrace.aoeiaol.top" target="_blank" 
               class="inline-flex items-center gap-2 mt-4 px-4 py-1.5 rounded-full bg-slate-800 border border-slate-600 text-xs text-slate-300 hover:bg-slate-700 hover:text-cyan-400 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                <span id="lbl_source">æ•°æ®æ¥è‡ª batrace.aoeiaol.top</span>
            </a>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-8 justify-center items-center">
            <div class="w-full md:w-96">
                <input type="text" id="steamInput" 
                    placeholder="Steam64 ID..." 
                    class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-3 placeholder-slate-500 shadow-inner text-center">
            </div>
            
            <button onclick="runAnalysis()" id="btn_check"
                class="text-white bg-gradient-to-r from-cyan-500 to-blue-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-cyan-800 font-medium rounded-lg text-sm px-8 py-3 text-center shadow-lg transform active:scale-95 transition-transform whitespace-nowrap">
                å¼€å§‹æ£€æµ‹
            </button>
        </div>

        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"></div>
            <p class="mt-2 text-slate-400" id="lbl_analyzing">æ­£åœ¨åˆ†ææˆ˜å±€æ•°æ®...</p>
        </div>

        <div id="errorMsg" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded relative mb-6" role="alert">
            <span class="block sm:inline" id="errorText"></span>
        </div>

        <div id="resultPanel" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-slate-800/80 rounded-xl p-6 border border-slate-700 col-span-1 md:col-span-4 flex flex-col items-center relative overflow-hidden">
                    
                    <div id="playstyleTag" class="absolute top-4 right-4 px-3 py-1 rounded text-xs font-bold border transform rotate-3">
                        STYLE
                    </div>

                    <h2 class="text-xl font-bold text-slate-300 mb-2" id="lbl_maggot_index">è›†æŒ‡æ•° (Maggot Index)</h2>
                    <div class="text-6xl font-black mb-1" id="maggotScoreDisplay" style="text-shadow: 0 0 20px rgba(0,0,0,0.5);">
                        -
                    </div>
                    
                    <div id="currentPlayerName" class="text-xl text-cyan-300 font-bold mb-3 px-4 py-1 rounded-full bg-slate-900/50 border border-slate-700/50">
                        </div>

                    <div class="text-lg font-bold mb-4" id="maggotLabel">Unknown</div>
                    
                    <div class="w-full max-w-lg">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span id="lbl_god">ç¥ (1.0)</span>
                            <span id="lbl_maggot">çº¯è›† (10.0)</span>
                        </div>
                        <div class="maggot-meter-bg">
                            <div id="meterIndicator" class="maggot-indicator" style="left: 50%;"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 text-center col-span-1 md:col-span-1">
                    <div class="text-xs text-slate-400 mb-1" id="lbl_avg_rank_total">å¹³å‡ç»¼åˆæ’å</div>
                    <div class="text-2xl font-bold text-yellow-400" id="avgRank">0.0</div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 text-center col-span-1 md:col-span-1">
                    <div class="text-xs text-slate-400 mb-1" id="lbl_avg_rank_kill">å¹³å‡å‡»æ€æ’å</div>
                    <div class="text-2xl font-bold text-red-400" id="avgKillRank">0.0</div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 text-center col-span-1 md:col-span-1">
                    <div class="text-xs text-slate-400 mb-1" id="lbl_avg_rank_cap">å¹³å‡å ç‚¹æ’å</div>
                    <div class="text-2xl font-bold text-blue-400" id="avgCapRank">0.0</div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 text-center col-span-1 md:col-span-1">
                    <div class="text-xs text-slate-400 mb-1" id="lbl_matches">ç»Ÿè®¡å±€æ•°</div>
                    <div class="text-2xl font-bold text-white" id="matchCount">0</div>
                </div>
            </div>

            <h3 class="text-xl font-bold mb-4 pl-2 border-l-4 border-cyan-500" id="lbl_history">æœ€è¿‘æˆ˜ç»©æ˜ç»†</h3>
            <div class="overflow-x-auto rounded-lg border border-slate-700">
                <table class="w-full text-sm text-left text-slate-300">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-800">
                        <tr>
                            <th scope="col" class="px-6 py-3 w-32" id="th_score">æˆ‘çš„è´¡çŒ®</th>
                            <th scope="col" class="px-6 py-3" id="th_team_details">é˜Ÿä¼è¯¦æƒ… (è´¡çŒ®é™åº)</th>
                            <th scope="col" class="px-6 py-3 w-32 text-center" id="th_status">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="matchTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ================= å·¥å…·ï¼šHTML è½¬ä¹‰ï¼ˆé˜²å¾¡å¥‡æ€ªåå­—ï¼‰ =================
        function escapeHtml(text) {
            if (!text) return text;
            // å°†éå­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            const str = String(text);
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ================= é…ç½®ä¸è¯­è¨€åŒ… =================
        const translations = {
            zh: {
                title: "æ–­ç®­è›†æŒ‡æ•°",
                subtitle: "Broken Arrow Maggot Index",
                source: "æ•°æ®æ¥è‡ª batrace.aoeiaol.top",
                check: "å¼€å§‹æ£€æµ‹",
                analyzing: "æ­£åœ¨åˆ†ææˆ˜å±€æ•°æ®...",
                maggot_index: "è›†æŒ‡æ•°",
                god: "ç¥ (1.0)",
                maggot: "çº¯è›† (10.0)",
                lbl_avg_rank_total: "å¹³å‡ç»¼åˆæ’å",
                lbl_avg_rank_kill: "å¹³å‡å‡»æ€æ’å",
                lbl_avg_rank_cap: "å¹³å‡å ç‚¹æ’å",
                matches: "ç»Ÿè®¡å±€æ•° (æœ€è¿‘10åœº)",
                history: "æœ€è¿‘æˆ˜ç»©æ˜ç»†",
                th_score: "æˆ‘çš„è´¡çŒ®",
                th_team_details: "é˜Ÿä¼è¯¦æƒ… (ID: åˆ†æ•°)",
                th_status: "è¯„ä»·",
                err_input: "è¯·è¾“å…¥æœ‰æ•ˆçš„ Steam64 ID",
                err_network: "ç½‘ç»œè¯·æ±‚å¤±è´¥",
                err_data: "æœªèƒ½è§£æåˆ°æœ‰æ•ˆæ•°æ®",
                err_no_matches: "æœªæ‰¾åˆ°å¯¹å±€æ•°æ®",
                label_carry: "CARRY",
                label_normal: "æ™®é€š",
                label_pot: "èƒŒé”…",
                tag_killer: "âš”ï¸ å‡»æ€è¾¾äºº",
                tag_capper: "ğŸš© å ç‚¹è¾¾äºº",
                maggot_levels: ["ğŸ‘‘ ç»ä¸–å¤§è…¿ / ç–‘ä¼¼å¼€æŒ‚", "ğŸ¦ å›¢é˜Ÿä¸­åš", "ğŸ˜ ä¹Ÿå°±æ˜¯ä¸ªæ··å­", "ğŸ› åªæœ‰ä¸€ç‚¹è›†", "ğŸ’© çº¯ç§è›†ç‹"],
                sel_title: "èº«ä»½ç¡®è®¤",
                sel_desc: "å‘ç°å¤šåç©å®¶åœºæ¬¡ç›¸åŒï¼ˆç–‘ä¼¼ç»„é˜Ÿï¼‰ï¼Œè¯·ç¡®è®¤å“ªä¸€ä½æ˜¯æ‚¨ï¼š",
                me: "è¿™å°±æ˜¯æˆ‘"
            },
            en: {
                title: "Maggot Index",
                subtitle: "Broken Arrow Player Analysis",
                source: "Data: batrace.aoeiaol.top",
                check: "Check Now",
                analyzing: "Analyzing match data...",
                maggot_index: "Maggot Index",
                god: "GOD (1.0)",
                maggot: "MAGGOT (10.0)",
                lbl_avg_rank_total: "Avg Team Rank",
                lbl_avg_rank_kill: "Avg Kill Rank",
                lbl_avg_rank_cap: "Avg Cap Rank",
                matches: "Matches (Last 10)",
                history: "Recent Match Details",
                th_score: "My Score",
                th_team_details: "Team Details (Sorted by Score)",
                th_status: "Rating",
                err_input: "Please enter a valid Steam64 ID",
                err_network: "Network request failed",
                err_data: "Failed to parse data",
                err_no_matches: "No matches found",
                label_carry: "CARRY",
                label_normal: "NORMAL",
                label_pot: "SCAPEGOAT",
                tag_killer: "âš”ï¸ TERMINATOR",
                tag_capper: "ğŸš© OBJ MASTER",
                maggot_levels: ["ğŸ‘‘ GODLIKE", "ğŸ¦ TEAM CARRY", "ğŸ˜ AVERAGE JOE", "ğŸ› BIT OF A MAGGOT", "ğŸ’© PURE MAGGOT"],
                sel_title: "Identify Yourself",
                sel_desc: "Multiple players have identical match history. Please select yourself:",
                me: "This is me"
            },
            ru: {
                title: "Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ›Ğ¸Ñ‡Ğ¸Ğ½ĞºĞ¸",
                subtitle: "ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Broken Arrow",
                source: "Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ: batrace.aoeiaol.top",
                check: "ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ",
                analyzing: "ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...",
                maggot_index: "Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ›Ğ¸Ñ‡Ğ¸Ğ½ĞºĞ¸",
                god: "Ğ‘ĞĞ“ (1.0)",
                maggot: "Ğ›Ğ˜Ğ§Ğ˜ĞĞšĞ (10.0)",
                lbl_avg_rank_total: "Ğ¡Ñ€. Ñ€Ğ°Ğ½Ğ³",
                lbl_avg_rank_kill: "Ğ Ğ°Ğ½Ğ³ ÑƒĞ±Ğ¸Ğ¹ÑÑ‚Ğ²",
                lbl_avg_rank_cap: "Ğ Ğ°Ğ½Ğ³ Ñ‚Ğ¾Ñ‡ĞµĞº",
                matches: "ĞœĞ°Ñ‚Ñ‡ĞµĞ¹ (ĞŸĞ¾ÑĞ». 10)",
                history: "Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¹",
                th_score: "ĞœĞ¾Ğ¹ ÑÑ‡ĞµÑ‚",
                th_team_details: "ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° (Ğ¿Ğ¾ ÑÑ‡ĞµÑ‚Ñƒ)",
                th_status: "Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³",
                err_input: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Steam64 ID",
                err_network: "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸",
                err_data: "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…",
                err_no_matches: "ĞœĞ°Ñ‚Ñ‡Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹",
                label_carry: "Ğ¢ĞĞ©Ğ•Ğ ",
                label_normal: "ĞĞĞ Ğœ",
                label_pot: "Ğ’ĞĞ“ĞĞ",
                tag_killer: "âš”ï¸ Ğ£Ğ‘Ğ˜Ğ™Ğ¦Ğ",
                tag_capper: "ğŸš© Ğ—ĞĞ¥Ğ’ĞĞ¢Ğ§Ğ˜Ğš",
                maggot_levels: ["ğŸ‘‘ Ğ‘ĞĞ“", "ğŸ¦ Ğ¢ĞĞ©Ğ•Ğ ", "ğŸ˜ Ğ¡Ğ Ğ•Ğ”ĞĞ¯Ğ§ĞĞš", "ğŸ› ĞĞ•ĞœĞĞĞ“Ğ Ğ›Ğ˜Ğ§Ğ˜ĞĞšĞ", "ğŸ’© 100% Ğ›Ğ˜Ğ§Ğ˜ĞĞšĞ"],
                sel_title: "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ",
                sel_desc: "ĞĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¸Ğ¼ĞµÑÑ‚ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²ÑƒÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞµĞ±Ñ:",
                me: "Ğ­Ñ‚Ğ¾ Ñ"
            }
        };

        let currentLang = 'zh';
        let cachedMatches = [];

        // ================= Cookie å·¥å…· =================
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + "=" + value + ";expires=" + date.toUTCString() + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        // ================= åˆå§‹åŒ– =================
        window.onload = function() {
            const savedLang = getCookie('lang');
            if (savedLang) {
                setLanguage(savedLang);
            } else {
                document.getElementById('langModal').classList.remove('hidden');
            }
            const savedSteam = getCookie('steamId');
            if (savedSteam) {
                document.getElementById('steamInput').value = savedSteam;
            }
        };

        function selectLanguage(lang) {
            setLanguage(lang);
            document.getElementById('langModal').classList.add('hidden');
        }

        function setLanguage(lang) {
            currentLang = lang;
            setCookie('lang', lang, 365);
            
            ['en', 'zh', 'ru'].forEach(l => {
                const btn = document.getElementById(`btn_${l}`);
                if (l === lang) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const t = translations[lang];
            const setText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };

            setText('lbl_title', t.title);
            setText('lbl_subtitle', t.subtitle);
            setText('lbl_source', t.source);
            setText('btn_check', t.check);
            setText('lbl_analyzing', t.analyzing);
            setText('lbl_maggot_index', t.maggot_index);
            setText('lbl_god', t.god);
            setText('lbl_maggot', t.maggot);
            setText('lbl_avg_rank_total', t.lbl_avg_rank_total);
            setText('lbl_avg_rank_kill', t.lbl_avg_rank_kill);
            setText('lbl_avg_rank_cap', t.lbl_avg_rank_cap);
            setText('lbl_matches', t.matches);
            setText('lbl_history', t.history);
            setText('th_score', t.th_score);
            setText('th_team_details', t.th_team_details);
            setText('th_status', t.th_status);
            setText('lbl_select_player_title', t.sel_title);
            setText('lbl_select_player_desc', t.sel_desc);
        }

        // ================= æ ¸å¿ƒé€»è¾‘ =================
        function parseTruncatedJSON(content) {
            const objects = [];
            let depth = 0;
            let objStart = -1;
            let idx = content.indexOf('[');
            if (idx === -1) {
                try { return [JSON.parse(content)]; } catch(e) { return []; }
            }
            idx += 1;
            while (idx < content.length) {
                const char = content[idx];
                if (char === '{') {
                    if (depth === 0) objStart = idx;
                    depth++;
                } else if (char === '}') {
                    depth--;
                    if (depth === 0) {
                        const objStr = content.substring(objStart, idx + 1);
                        try { objects.push(JSON.parse(objStr)); } catch (e) {}
                    }
                }
                idx++;
            }
            return objects;
        }

        async function runAnalysis() {
            const steamId = document.getElementById('steamInput').value.trim();
            const t = translations[currentLang];
            
            if (!steamId) {
                showError(t.err_input);
                return;
            }
            setCookie('steamId', steamId, 30);

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultPanel').classList.add('hidden');
            document.getElementById('errorMsg').classList.add('hidden');
            document.getElementById('playerSelectModal').classList.add('hidden');

            try {
                const url = `https://batrace.aoeiaol.top/api/v1/matches_steam64?steam64=${steamId}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(t.err_network + `: ${response.status}`);
                const rawText = await response.text();
                const allObjects = parseTruncatedJSON(rawText);
                
                if (allObjects.length === 0) throw new Error(t.err_data);

                prepareData(allObjects);

            } catch (err) {
                showError(err.message);
                console.error(err);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function prepareData(allObjects) {
            const t = translations[currentLang];
            const matches = allObjects.filter(obj => obj.type === 'match');

            if (matches.length === 0) {
                showError(t.err_no_matches);
                return;
            }

            // ä¿®æ”¹ï¼šæŒ‰ EndTime å€’åºæ’åº (æœ€è¿‘çš„åœ¨å‰)
            matches.sort((a, b) => {
                const timeA = (a.data && a.data.EndTime) ? a.data.EndTime : 0;
                const timeB = (b.data && b.data.EndTime) ? b.data.EndTime : 0;
                return timeB - timeA;
            });

            // æˆªå–æœ€è¿‘10å±€
            const recentMatches = matches.slice(0, 10);
            cachedMatches = recentMatches;

            // æ™ºèƒ½è¯†åˆ«ç©å®¶ ID
            const idCounts = {};
            const idNames = {}; // è®°å½• ID å¯¹åº”çš„åå­—

            recentMatches.forEach(m => {
                if(m.data && m.data.Data) {
                    Object.values(m.data.Data).forEach(p => {
                        idCounts[p.Id] = (idCounts[p.Id] || 0) + 1;
                        if (p.Name) idNames[p.Id] = p.Name; 
                    });
                }
            });

            let maxCount = 0;
            for (const count of Object.values(idCounts)) {
                if (count > maxCount) maxCount = count;
            }

            const candidates = [];
            for (const [id, count] of Object.entries(idCounts)) {
                if (count === maxCount) {
                    candidates.push({
                        id: id,
                        name: idNames[id] || `Unknown (${id})`
                    });
                }
            }

            if (candidates.length === 0) {
                showError(t.err_data);
            } else if (candidates.length === 1) {
                analyzeData(candidates[0].id);
            } else {
                showPlayerSelectModal(candidates);
            }
        }

        function showPlayerSelectModal(candidates) {
            const modal = document.getElementById('playerSelectModal');
            const list = document.getElementById('playerSelectList');
            const t = translations[currentLang];
            
            list.innerHTML = '';
            
            candidates.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded bg-slate-700 hover:bg-cyan-700 hover:shadow-lg transition border border-slate-600 flex justify-between items-center group";
                
                // ä½¿ç”¨ escapeHtml é˜²æ­¢ä¹±ç æˆ–XSS
                const safeName = escapeHtml(c.name);
                
                btn.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-white group-hover:text-white truncate pr-2">${safeName}</div>
                        <div class="text-xs text-slate-400">ID: ${c.id}</div>
                    </div>
                    <div class="text-xs px-3 py-1 bg-slate-800 rounded text-slate-300 group-hover:bg-cyan-600 group-hover:text-white transition flex-shrink-0">
                        ${t.me}
                    </div>
                `;
                btn.onclick = () => {
                    modal.classList.add('hidden');
                    analyzeData(c.id);
                };
                list.appendChild(btn);
            });
            
            modal.classList.remove('hidden');
        }

        function closePlayerModal() {
            document.getElementById('playerSelectModal').classList.add('hidden');
        }

        function analyzeData(mainPlayerId) {
            const t = translations[currentLang];
            const stats = [];
            let mainPlayerName = "";

            cachedMatches.forEach(match => {
                if (!match.data || !match.data.Data || !match.data.Data[mainPlayerId]) return;

                const data = match.data.Data;
                const me = data[mainPlayerId];
                const myTeam = me.TeamId;
                
                // è®°å½•åå­—ï¼ˆå–æœ€æ–°ä¸€å±€æˆ–ä»»æ„ä¸€å±€çš„æœ‰åå­—çš„ï¼‰
                if (me.Name) mainPlayerName = me.Name;

                let teammates = Object.values(data).filter(p => p.TeamId == myTeam);
                
                const processed = teammates.map(p => {
                    const d = p.DestructionScore || 0;
                    const l = p.LossesScore || 0;
                    const obj = p.ObjectivesCaptured || 0;
                    const killScore = (d - l) / 1000;
                    
                    return {
                        id: p.Id,
                        name: p.Name || p.Id,
                        killScore: killScore,
                        capScore: obj,
                        totalScore: killScore + obj,
                        isMe: (p.Id == mainPlayerId)
                    };
                });
                
                processed.sort((a, b) => b.totalScore - a.totalScore);
                const myRank = processed.findIndex(p => p.isMe) + 1;
                const myEntry = processed.find(p => p.isMe);

                const killSorted = [...processed].sort((a, b) => b.killScore - a.killScore);
                const myKillRank = killSorted.findIndex(p => p.isMe) + 1;

                const capSorted = [...processed].sort((a, b) => b.capScore - a.capScore);
                const myCapRank = capSorted.findIndex(p => p.isMe) + 1;
                
                stats.push({
                    myScore: myEntry.totalScore,
                    myRank: myRank,
                    myKillRank: myKillRank,
                    myCapRank: myCapRank,
                    teamSize: processed.length,
                    teamDetails: processed
                });
            });
            
            // æ˜¾ç¤ºåå­—
            const nameEl = document.getElementById('currentPlayerName');
            if (mainPlayerName) {
                nameEl.innerHTML = escapeHtml(mainPlayerName);
                nameEl.classList.remove('hidden');
            } else {
                nameEl.innerHTML = `ID: ${mainPlayerId}`;
            }

            renderResults(stats);
        }

        function renderResults(stats) {
            const t = translations[currentLang];
            if (stats.length === 0) {
                showError(t.err_no_matches);
                return;
            }

            const avgRank = stats.reduce((sum, s) => sum + s.myRank, 0) / stats.length;
            const avgKillRank = stats.reduce((sum, s) => sum + s.myKillRank, 0) / stats.length;
            const avgCapRank = stats.reduce((sum, s) => sum + s.myCapRank, 0) / stats.length;

            const normalizedRank = (avgRank - 1) / 4; 
            const clampedNorm = Math.max(0, Math.min(1, normalizedRank));
            const sCurveValue = (1 - Math.cos(clampedNorm * Math.PI)) / 2;
            let maggotIndex = 1 + sCurveValue * 9;
            
            if (maggotIndex < 1) maggotIndex = 1;
            if (maggotIndex > 10) maggotIndex = 10;

            document.getElementById('resultPanel').classList.remove('hidden');
            
            const tagEl = document.getElementById('playstyleTag');
            if (avgKillRank <= avgCapRank) {
                tagEl.innerText = t.tag_killer;
                tagEl.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-bold border transform rotate-3 bg-red-900/80 border-red-500 text-red-200 shadow-[0_0_10px_rgba(239,68,68,0.5)]";
            } else {
                tagEl.innerText = t.tag_capper;
                tagEl.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-bold border transform rotate-3 bg-blue-900/80 border-blue-500 text-blue-200 shadow-[0_0_10px_rgba(59,130,246,0.5)]";
            }

            const scoreEl = document.getElementById('maggotScoreDisplay');
            scoreEl.innerText = maggotIndex.toFixed(1);
            
            if (maggotIndex <= 3) scoreEl.className = "text-6xl font-black mb-1 text-green-400";
            else if (maggotIndex <= 7) scoreEl.className = "text-6xl font-black mb-1 text-yellow-400";
            else scoreEl.className = "text-6xl font-black mb-1 text-red-500";

            let labelIndex = 0;
            if (maggotIndex <= 2) labelIndex = 0;
            else if (maggotIndex <= 4) labelIndex = 1;
            else if (maggotIndex <= 6) labelIndex = 2;
            else if (maggotIndex <= 8) labelIndex = 3;
            else labelIndex = 4;
            document.getElementById('maggotLabel').innerText = t.maggot_levels[labelIndex];

            const percentage = ((maggotIndex - 1) / 9) * 100;
            document.getElementById('meterIndicator').style.left = `${percentage}%`;

            document.getElementById('avgRank').innerText = avgRank.toFixed(1);
            document.getElementById('avgKillRank').innerText = avgKillRank.toFixed(1);
            document.getElementById('avgCapRank').innerText = avgCapRank.toFixed(1);
            document.getElementById('matchCount').innerText = stats.length;

            const tbody = document.getElementById('matchTableBody');
            tbody.innerHTML = "";
            
            // ä¿æŒæ—¶é—´å€’åºæ˜¾ç¤ºï¼ˆæœ€è¿‘çš„åœ¨ä¸Šé¢ï¼‰
            stats.forEach((s) => {
                const tr = document.createElement('tr');
                tr.className = "match-row bg-slate-800 border-b border-slate-700";
                
                let scoreColor = "text-slate-300";
                if (s.myRank === 1) scoreColor = "text-green-400 font-bold";
                else if (s.myRank === 5) scoreColor = "text-red-400";

                let teamHtml = `<div class="flex flex-col gap-1">`;
                s.teamDetails.forEach(p => {
                    const isMeClass = p.isMe ? "is-me" : "text-slate-400";
                    // åå­—ä¹Ÿè¦è½¬ä¹‰
                    const safeTeammateName = escapeHtml(p.name);
                    teamHtml += `
                        <div class="teammate-badge ${isMeClass}">
                            <span class="truncate max-w-[120px]">${safeTeammateName}</span>
                            <span>${p.totalScore.toFixed(2)}</span>
                        </div>
                    `;
                });
                teamHtml += `</div>`;

                let statusLabel = "";
                if (s.myRank === 1) {
                    statusLabel = `<span class="px-2 py-1 rounded bg-green-900 text-green-300 text-xs font-bold whitespace-nowrap">${t.label_carry}</span>`;
                } else if (s.myRank === 5) {
                    statusLabel = `<span class="px-2 py-1 rounded bg-red-900 text-red-300 text-xs font-bold whitespace-nowrap">${t.label_pot}</span>`;
                } else {
                    statusLabel = `<span class="px-2 py-1 rounded bg-blue-900 text-blue-300 text-xs whitespace-nowrap">${t.label_normal}</span>`;
                }

                const detailedRanks = `
                    <div class="mt-1 flex gap-1 justify-center">
                        <span class="rank-pill rank-pill-kill" title="Kill Rank">K#${s.myKillRank}</span>
                        <span class="rank-pill rank-pill-cap" title="Cap Rank">C#${s.myCapRank}</span>
                    </div>
                `;

                tr.innerHTML = `
                    <td class="px-6 py-4 align-top ${scoreColor} text-lg font-mono">${s.myScore.toFixed(2)}</td>
                    <td class="px-6 py-4 align-top">${teamHtml}</td>
                    <td class="px-6 py-4 align-top text-center">${statusLabel}${detailedRanks}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showError(msg) {
            document.getElementById('errorMsg').classList.remove('hidden');
            document.getElementById('errorText').innerText = msg;
        }
    </script>
</body>
</html>
